<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cotización — MDC DIGITAL · Odontología Inteligente</title>

  <!-- Tailwind y fuentes -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Exportar a PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    :root{
      --brand:#ff2f6b;
      --brand-dark:#2b2d33;
      --brand-gray:#9aa3ad;
      --brand-light:#f6f7fb;
      --thumb-h: 320px;
    }
    html,body{ font-family:'Inter',system-ui,Segoe UI,Roboto,Helvetica,Arial; }
    .brand{ color:var(--brand); }
    .brand-bg{ background:var(--brand); }
    .brand-gray{ color:var(--brand-gray); }
    .btn-brand{ background:var(--brand); color:#fff; }
    .btn-brand:hover{ filter:brightness(.93); }
    .card{ border-radius:1rem; box-shadow:0 8px 18px rgba(0,0,0,.05); }

    .brand-logo { width: 28px; height: 28px; object-fit: contain; }
    .brand-logo-lg { width: 36px; height: 36px; object-fit: contain; }

    .prod-img{ width:100%; height:var(--thumb-h); background:#fff; border-radius:0.75rem; overflow:hidden; border:1px solid #eef2f7; }
    .prod-img img{ width:100%; height:100%; object-fit:contain; padding:10px; cursor:zoom-in; }

    .pdf-prod-img{ width:150px; height:150px; object-fit:contain; border:1px solid #e5e7eb; border-radius:.5rem; }

    .cart-list .hdr{ display:none; }
    @media (min-width: 640px){
      .cart-list .hdr{
        display:grid; grid-template-columns: 1fr auto auto 42px;
        column-gap:1rem; padding:.5rem .5rem; font-size:.75rem; color:#6b7280; border-bottom:1px solid #e5e7eb;
      }
    }
    .cart-list .row{ display:grid; grid-template-columns: 1fr auto; row-gap:.35rem; column-gap:1rem; align-items:center; padding:.75rem .5rem; border-bottom:1px solid #e5e7eb; }
    @media (min-width: 640px){ .cart-list .row{ grid-template-columns: 1fr auto auto 42px; } }
    .cart-name{ font-size:.9rem; line-height:1.15; }
    .cart-num{ white-space:nowrap; text-align:right; font-variant-numeric: tabular-nums; }
    .cart-qty{ width:70px; text-align:right; }
    .trash-btn{ color:#ef4444; display:inline-flex; align-items:center; justify-content:center; width:32px; height:32px; border-radius:.5rem; }
    .trash-btn:hover{ background:#fee2e2; }

    .brand-chip{ display:inline-flex; align-items:center; gap:.55rem; border:1px solid #e5e7eb; border-radius:9999px; padding:.6rem 1.05rem; cursor:pointer; user-select:none; font-size:1rem; }
    .brand-chip.active{ background:#fff0f5; border-color:var(--brand); color:var(--brand); }
    .brand-chip .count{ font-variant-numeric: tabular-nums; font-size:.9rem; color:#6b7280; }

    #toastStack{ position:fixed; top:16px; right:16px; z-index:60; display:flex; flex-direction:column; gap:10px; }
    .toast{ background:#111827; color:#fff; padding:10px 12px; border-radius:12px; box-shadow:0 10px 20px rgba(0,0,0,.18); display:flex; gap:8px; align-items:center; opacity:0; transform:translateY(-6px); transition:opacity .2s ease, transform .2s ease; font-size:.9rem; }
    .toast.show{ opacity:1; transform:translateY(0); }
    .toast.success{ background:#065f46; }
    .toast.warn{ background:#92400e; }
    .toast.info{  background:#1f2937; }

    @media print{
      .no-print{ display:none !important; }
      body * { visibility:hidden; }
      #pdfDoc, #pdfDoc * { visibility:visible; }
      #pdfDoc { position:relative; left:0; top:0; display:block !important; }
      .card{ box-shadow:none !important; border:1px solid #e5e7eb; }
    }

    #jsErrorBanner{position:fixed;bottom:8px;left:8px;right:8px;background:#b91c1c;color:#fff;padding:10px 12px;border-radius:10px;z-index:70;box-shadow:0 10px 20px rgba(0,0,0,.25);font-size:.9rem;}
  </style>
</head>
<body class="bg-[var(--brand-light)] text-[var(--brand-dark)] min-h-screen">

  <header class="sticky top-0 z-10 bg-white/90 backdrop-blur border-b border-neutral-200 no-print">
    <div class="max-w-7xl mx-auto px-4 py-3 flex items-center gap-4">
      <img src="logo-mdc.png" onerror="this.src='mdc digital color.png'" alt="MDC DIGITAL" class="h-10 w-auto" />
      <div>
        <h1 class="text-xl font-bold tracking-tight">MDC <span class="brand">DIGITAL</span></h1>
        <p class="text-xs brand-gray -mt-0.5">Odontología Inteligente</p>
      </div>
      <div class="ml-auto flex items-center gap-2">
        <button id="btnPDF" class="btn-brand px-4 py-2 rounded-2xl shadow">Descargar PDF</button>
        <button id="btnPrint" class="px-4 py-2 rounded-2xl border border-[var(--brand)] text-[var(--brand)]">Imprimir</button>
      </div>
    </div>
    <div class="brand-bg h-1 w-full"></div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6 grid grid-cols-1 lg:grid-cols-3 gap-6 no-print">
    <section class="lg:col-span-2 space-y-4">
      <!-- Filtros -->
      <div class="card bg-white p-4">
        <div class="flex flex-wrap items-center gap-2">
          <div class="grow grid sm:grid-cols-2 gap-2">
            <input id="q" class="border rounded-xl px-3 py-2" placeholder="Buscar (nombre, specs)" />
            <select id="category" class="border rounded-xl px-3 py-2">
              <option value="">Todas las categorías</option>
            </select>
          </div>
          <button id="apply" class="btn-brand px-4 py-2 rounded-2xl">Filtrar</button>
          <button id="clear" class="px-4 py-2 rounded-2xl border border-[var(--brand)] text-[var(--brand)]">Limpiar</button>
        </div>
      </div>

      <!-- Marcas -->
      <div class="card bg-white p-4">
        <div class="flex items-center justify-between mb-2">
          <h3 class="font-semibold">Marcas</h3>
          <button id="clearBrand" class="text-sm text-[var(--brand)] underline">Todas</button>
        </div>
        <div id="brandChips" class="flex flex-wrap gap-2"></div>
      </div>

      <!-- Catálogo -->
      <div id="catalog"></div>
    </section>

    <!-- Resumen + Financiamiento -->
    <aside class="space-y-4 print:space-y-2">
      <div id="summaryCard" class="card bg-white p-4">
        <h2 class="font-semibold mb-2">Resumen</h2>

        <!-- A nombre de -->
        <div class="mb-3">
          <label for="quoteTo" class="text-sm block mb-1">A nombre de</label>
          <input id="quoteTo" type="text" class="border rounded-xl px-3 py-2 w-full" placeholder="Ej. Laboratorio Dental XYZ">
        </div>

        <div class="text-sm space-y-2">
          <div class="flex justify-between"><span>Subtotal</span><span id="subtotal">$0.00</span></div>

          <div class="flex justify-between items-center gap-2">
            <label class="flex items-center gap-2">
              <span>Descuento (%)</span>
              <input id="discount" type="number" class="border rounded px-2 py-1 w-20" value="0" min="0" max="100" />
            </label>
            <span id="discountAmt">-$0.00</span>
          </div>

          <div id="ivaRow" class="flex justify-between items-center gap-2">
            <span>IVA (16%)</span>
            <span id="ivaAmt">$0.00</span>
          </div>

          <div class="border-t pt-2 flex justify-between text-base font-semibold">
            <span>Total</span><span id="total">$0.00</span>
          </div>

          <!-- Enganche visible en resumen -->
          <div class="flex justify-between items-center gap-2">
            <span>Enganche actual (<span id="downPctNow">20%</span>)</span>
            <span id="downAmtNow">$0.00</span>
          </div>

          <!-- Modo internacional -->
          <div class="mt-2 grid grid-cols-1 gap-2">
            <label class="inline-flex items-center gap-2">
              <input id="intl" type="checkbox" class="w-4 h-4 accent-[var(--brand)]">
              <span>Internacional (USD, sin IVA)</span>
            </label>
            <div id="fxWrap" class="flex items-center gap-2 ml-6 hidden">
              <span class="text-xs brand-gray">Tipo de cambio (MXN → USD):</span>
              <input id="fx" type="number" step="0.01" min="0.0001" value="17.00" class="border rounded px-2 py-1 w-28">
            </div>
          </div>
        </div>

        <!-- Carrito -->
        <div id="cartTable" class="mt-3 border-t pt-3 cart-list"></div>
      </div>

      <div class="card bg-white p-4">
        <h3 class="font-semibold mb-2">Financiamiento</h3>

        <div class="grid md:grid-cols-2 gap-3 text-sm">
          <div class="flex items-center gap-2">
            <label class="whitespace-nowrap">Enganche:</label>
            <select id="downPct" class="border rounded px-2 py-1">
              <option value="0.2">20%</option>
              <option value="0.3">30%</option>
              <option value="0.4">40%</option>
              <option value="0.5">50%</option>
              <option value="custom">Personalizado</option>
            </select>
          </div>

          <div id="downCustomWrap" class="flex items-center gap-2 hidden">
            <input id="downPctCustom" type="number" min="20" max="100" step="1" value="20"
                   class="border rounded px-2 py-1 w-24">
            <span>%</span>
            <span class="text-xs brand-gray">Mín. 20%, máx. 100%</span>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-2 text-sm mt-3" id="finTable"></div>
      </div>

      <div class="flex gap-2 no-print">
        <button id="btnClearCart" class="px-4 py-2 rounded-2xl border border-[var(--brand)] text-[var(--brand)]">Vaciar carrito</button>
      </div>
    </aside>
  </main>

  <!-- Documento PDF -->
  <section id="pdfDoc" class="max-w-4xl mx-auto bg-white rounded-2xl shadow p-6 my-8" style="display:none">
    <div class="flex items-center gap-4">
      <img src="logo-mdc.png" onerror="this.src='mdc digital color.png'" class="h-12 w-auto" alt="MDC" />
      <div>
        <h2 class="text-xl font-bold">Cotización · MDC <span class="brand">DIGITAL</span></h2>
        <p class="text-xs brand-gray">Odontología Inteligente</p>
      </div>
      <div class="ml-auto text-sm text-right">
        <div><span class="brand-gray">Folio:</span> <span id="pdfFolio" class="font-semibold"></span></div>
        <div><span class="brand-gray">Fecha:</span> <span id="pdfDate" class="font-semibold"></span></div>
        <div><span class="brand-gray">Vigencia:</span> <span id="pdfValidUntil" class="font-semibold"></span></div>
      </div>
    </div>

    <!-- Para / A nombre de -->
    <div id="pdfForRow" class="mt-3 text-sm" style="display:none;">
      <span class="brand-gray">A nombre de:</span>
      <span id="pdfFor" class="font-medium"></span>
    </div>

    <div class="brand-bg h-0.5 w-full my-4"></div>

    <h3 class="font-semibold mb-2">Productos seleccionados</h3>
    <table class="w-full text-sm border">
      <thead class="bg-gray-50">
        <tr>
          <th class="p-2 text-left">Producto</th>
          <th class="p-2 text-right" id="pdfPriceHeader">Precio</th>
          <th class="p-2 text-right">Cant</th>
          <th class="p-2 text-right">Importe</th>
        </tr>
      </thead>
      <tbody id="pdfItemsBody"></tbody>
    </table>

    <div class="grid sm:grid-cols-2 gap-4 mt-4">
      <div class="text-xs brand-gray" id="pdfNotesLeft">Moneda: MXN.</div>
      <div class="border rounded-xl p-3">
        <div class="flex justify-between text-sm"><span>Subtotal</span><span id="pdfSubtotal">$0.00</span></div>
        <div class="flex justify-between text-sm"><span>Descuento</span><span id="pdfDiscount">-$0.00</span></div>
        <div class="flex justify-between text-sm" id="pdfIvaRow"><span>IVA</span><span id="pdfIva">$0.00</span></div>
        <div class="border-t mt-2 pt-2 flex justify-between font-semibold"><span>Total</span><span id="pdfTotal">$0.00</span></div>
      </div>
    </div>

    <div class="mt-6">
      <h3 class="font-semibold mb-2">Plan de financiamiento</h3>
      <div class="text-sm mb-2">
        Enganche (planes con interés): <span id="pdfDownPct">20%</span> · Monto: <span id="pdfDownAmt">$0.00</span>
      </div>
      <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 text-sm" id="pdfFinTable"></div>
    </div>

    <!-- Datos de contacto -->
    <div class="mt-6 text-xs" id="pdfContact"></div>

    <div class="mt-6 text-xs brand-gray" id="pdfNotesBottom">
      <p>Las cotizaciones vencen al mes de generadas. Precios referenciales 2025; sujetos a cambio sin previo aviso. Entrega estimada según equipo. Fresadoras: instalación y capacitación presencial. Otros equipos: instalación y capacitación remota.</p>
    </div>
  </section>

  <footer class="text-center text-xs brand-gray pb-8 no-print">
    © <span id="year"></span> MDC DIGITAL • Odontología Inteligente
  </footer>

  <!-- Modal imagen -->
  <div id="imgModal" class="fixed inset-0 z-50 hidden no-print items-center justify-center bg-black/70 p-4" role="dialog" aria-modal="true" aria-labelledby="modalCaption">
    <div class="relative bg-white rounded-2xl shadow-xl max-w-3xl w-full">
      <button id="modalClose" class="absolute top-3 right-3 p-2 rounded-lg text-gray-500 hover:bg-gray-100" aria-label="Cerrar (Esc)">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
      <img id="modalImg" class="w-full h-auto object-contain max-h-[75vh] rounded-t-2xl" alt="">
      <div class="p-3"><div id="modalCaption" class="text-sm text-gray-600"></div></div>
    </div>
  </div>

  <div id="toastStack" class="no-print"></div>

  <!-- Catálogo embebido -->
  <script id="catalogData" type="application/json">
  [
    {"sku":"RHINO-A51","name":"Fresadora RHINO A51 Seco","brand":"Rhino","category":"Fresadoras","unit_price":353970,"description":"5 ejes en seco, JAEGER, PANASONIC, cambiador automático."},
    {"sku":"RHINO-A52","name":"Fresadora RHINO A52 Seco","brand":"Rhino","category":"Fresadoras","unit_price":369360,"description":"5 ejes seco, PC táctil 12\", spindle 820W, C-Clamp 12 fresas."},
    {"sku":"RHINO-A52W","name":"Fresadora RHINO A52W Húmedo-Seco","brand":"Rhino","category":"Fresadoras","unit_price":415530,"description":"5 ejes híbrida, depósito de agua, PC táctil, spindle 820W."},
    {"sku":"COR-150I-PRO","name":"CORiTEC 150i Touch PRO Húmedo-Seco","brand":"imes-icore","category":"Fresadoras","unit_price":569666,"description":"5 ejes, 100k rpm, PC integrado, Smart Control."},
    {"sku":"COR-150I-DRY","name":"CORiTEC 150i Touch Seco","brand":"imes-icore","category":"Fresadoras","unit_price":486655,"description":"5 ejes en seco, 100k rpm, PC integrado."},
    {"sku":"COR-250I-PRO+","name":"CORiTEC 250i PRO PLUS Húmedo/Seco","brand":"imes-icore","category":"Fresadoras","unit_price":759555,"description":"Húmedo y seco, 1.0 kW, 60k rpm, ionizador, cámara HD, autocalibración."},
    {"sku":"COR-350I-PRO","name":"CORiTEC 350i PRO (CoCr/Ti)","brand":"imes-icore","category":"Fresadoras","unit_price":1139563,"description":"5 ejes, húmedo-seco, 60k rpm, cambio 20 herramientas."},
    {"sku":"COR-350I-PRO+","name":"CORiTEC 350i PRO+ PLUS","brand":"imes-icore","category":"Fresadoras","unit_price":1279453,"description":"2.6 kW, 60k rpm, base de hormigón polímero, 24/7, zero-point."},
    {"sku":"COR-350I-LOADER","name":"CORiTEC 350i PRO LOADER","brand":"imes-icore","category":"Fresadoras","unit_price":1365539,"description":"5 ejes con cargador automático, 60k rpm."},
    {"sku":"COR-ONEPLUS","name":"CORiTEC ONE+ plus","brand":"imes-icore","category":"Fresadoras","unit_price":618513,"description":"5 ejes, húmedo integrado, premoldeados Ti/CoCr, 100k rpm."},

    {"sku":"SCAN-T310","name":"Scanner MEDIT T310","brand":"Medit","category":"Escáneres","unit_price":95700,"description":"2 cámaras 5MP, 9µm, USB 3.0."},
    {"sku":"SCAN-T510","name":"Scanner MEDIT T510","brand":"Medit","category":"Escáneres","unit_price":133650,"description":"2 cámaras 5MP, 7µm, 12s arcada."},
    {"sku":"SCAN-T710","name":"Scanner MEDIT T710","brand":"Medit","category":"Escáneres","unit_price":207900,"description":"4 cámaras 5MP, 4µm, 8s arcada."},

    {"sku":"OVO-3DISC","name":"Scanner 3 DISC OVO 3 (Intraoral)","brand":"3DISC","category":"Escáneres intraorales","unit_price":125776,"description":"12–20µm, 150g, punta 360°, STL/OBJ/PLY."},
    {"sku":"MEDIT-I600","name":"Medit i600 (Intraoral)","brand":"Medit","category":"Escáneres intraorales","unit_price":160000,"description":"Hasta 70 FPS, 10.9µm arco completo."},
    {"sku":"MEDIT-I700","name":"Medit i700 (Intraoral)","brand":"Medit","category":"Escáneres intraorales","unit_price":232320,"description":"Hasta 70 FPS, 10.9µm arco completo."},
    {"sku":"BLZ-INO200","name":"BLZ INO200 (Intraoral)","brand":"BLZ","category":"Escáneres intraorales","unit_price":87000,"description":"Hasta 70 FPS, 10.9µm arco completo."},

    {"sku":"NEXD-5100","name":"NextDent 5100 3D Printer","brand":"NextDent","category":"Impresoras 3D","unit_price":196551,"description":"DLP 405nm, Figure 4, alta velocidad."},
    {"sku":"ELE-MARS4","name":"IMPRESORA 3D ELEGOO MARS 4 9K","brand":"ELEGOO","category":"Impresoras 3D","unit_price":4500,"description":"LCD, Sistema abierto, alta velocidad."},
    {"sku":"ELE-MARS5","name":"IMPRESORA 3D ELEGOO MARS 5 9K","brand":"ELEGOO","category":"Impresoras 3D","unit_price":6000,"description":"LCD, Sistema abierto, alta velocidad."},
    {"sku":"ELE-SATU4","name":"IMPRESORA 3D ELEGOO SATURN 4 16K","brand":"ELEGOO","category":"Impresoras 3D","unit_price":9000,"description":"LCD, Sistema abierto, alta velocidad."},

    {"sku":"SOFT-HDEXP-SEC","name":"hyperDENT Express Seco","brand":"hyperDENT","category":"Software","unit_price":66602,"description":"CAM dental ideal para maquinas Rhino en Seco."},
    {"sku":"SOFT-HDEXP-HUM","name":"hyperDENT Express Humedo","brand":"hyperDENT","category":"Software","unit_price":80000,"description":"CAM dental ideal para maquinas Rhino en Humedo."},
    {"sku":"SOFT-HDCOM-SI","name":"hyperDENT Compact Sin Implantes","brand":"hyperDENT","category":"Software","unit_price":100000,"description":"CAM dental ideal para maquinas Rhino que trabajen implantes"},
    {"sku":"SOFT-HDCOM-CI","name":"hyperDENT Compact Con Implantes","brand":"hyperDENT","category":"Software","unit_price":120000,"description":"CAM dental ideal para fresar implant-based en metal"},
    {"sku":"SOFT-ICAM-ECO","name":"iCAM V5 smart eco","brand":"imes-icore","category":"Software","unit_price":109452,"description":"CAM abierto, 5 ejes, para maquinas CORiTEC chicas"},
    {"sku":"SOFT-ICAM-SMT","name":"iCAM V5 smart","brand":"imes-icore","category":"Software","unit_price":129452,"description":"CAM abierto, 5 ejes, para maquinas CORiTEC grandes"},
    {"sku":"SOFT-ICAM-POST","name":"Postprocesador iCAM V5 smart","brand":"imes-icore","category":"Software","unit_price":21551,"description":"Modulo para agregar maquinas a iCAM V5 smart"},
    {"sku":"SOFT-ICAM-UPGRADE","name":"iCAM V5 smart UPGRADE","brand":"imes-icore","category":"Software","unit_price":69913,"description":"Actualización a la ultima versión de iCAM V5 smart"},

    {"sku":"VAC-R412","name":"Unidad de Succión R412 Rhino","brand":"Rhino","category":"Accesorios","unit_price":18468,"description":"Compacta, <65dB, motor sin escobillas."},
    {"sku":"VAC-IVAC-SIL","name":"Unidad de Succión iVAC Silence","brand":"imes-icore","category":"Accesorios","unit_price":32497,"description":"Compacta, silenciosa, Filtro HEPA."},
    {"sku":"VAC-IVAC-EC+","name":"Unidad de Succión iVAC ECO+","brand":"imes-icore","category":"Accesorios","unit_price":32497,"description":"Compacta, alto flujo, Filtro HEPA."},
    {"sku":"KIT-350I","name":"Kit de inicio para serie 350i, 250i PRO","brand":"imes-icore","category":"Accesorios","unit_price":25164,"description":"Herramientas y accesorios para funcion de la maquina"},
    {"sku":"KIT-150I","name":"Kit de inicio para serie 150i","brand":"imes-icore","category":"Accesorios","unit_price":22515,"description":"Herramientas y accesorios para funcion de la maquina"},

    {"sku":"HORN-GT1","name":"Horno de Sinterizado Zirconia GT1","brand":"Rhino","category":"Hornos","unit_price":97812,"description":"SiC, LCD, monitoreo en tiempo real."},
    {"sku":"HORN-KDF","name":"Horno de Sinterizado KDF Zircom/Speed","brand":"KDF","category":"Hornos","unit_price":222750,"description":"Hasta 1600°C, MoSi2, LCD 3.5\"."}
  ]
  </script>

  <script>
    /* ===== Banner errores JS ===== */
    window.addEventListener('error', function(e){
      try{
        var old = document.getElementById('jsErrorBanner');
        if(old) old.remove();
        var div = document.createElement('div');
        div.id = 'jsErrorBanner';
        div.textContent = 'Error de JavaScript: ' + e.message;
        document.body.appendChild(div);
      }catch(_){}
    });

    window.addEventListener('DOMContentLoaded', function(){
      /* ===== Parámetros ===== */
      var APR = 22;           // Interés anual (planes con interés)
      var IVA_PCT = 16;       // IVA fijo
      var INCLUDE_PDF_IMAGES = true;
      var MAX_QTY_PER_PRODUCT = 10;

      /* Datos de contacto para el PDF (edítalos a tu gusto) */
      var CONTACT = {
        phone: "+52 55 0000 0000",
        email: "ventas@mdcdigital.mx",
        site:  "www.mdcdigital.mx",
        address: "CDMX, México"
      };

      var BRAND_LOGOS = {
        "Rhino": "images/brands/rhino.png",
        "imes-icore": "images/brands/imes-icore.png",
        "Medit": "images/brands/medit.png",
        "3DISC": "images/brands/3disc.png",
        "BLZ": "images/brands/blz.png",
        "NextDent": "images/brands/nextdent.png",
        "ELEGOO": "images/brands/elegoo.png",
        "hyperDENT": "images/brands/hyperdent.png",
        "KDF": "images/brands/kdf.png"
      };
      function slug(s){ return String(s).normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,''); }
      function brandLogoUrl(b){ return BRAND_LOGOS[b] || (b ? ('images/brands/' + slug(b) + '.png') : ''); }

      var FOLIO_START = 1;
      var CURRENT_FOLIO = null;
      function nextFolio() {
        var d = new Date();
        var ym = '' + d.getFullYear() + String(d.getMonth()+1).padStart(2,'0');
        var key = 'mdc_folio_seq_' + ym;
        var seq = parseInt(localStorage.getItem(key) == null ? (FOLIO_START - 1) : localStorage.getItem(key), 10);
        seq = isNaN(seq) ? 0 : seq;
        seq += 1;
        localStorage.setItem(key, String(seq));
        return 'MDC-' + ym + '-' + String(seq).padStart(5,'0');
      }
      function ensureFolio(){
        if (!CURRENT_FOLIO){
          CURRENT_FOLIO = nextFolio();
          document.getElementById('pdfFolio').textContent = CURRENT_FOLIO;
        }
        return CURRENT_FOLIO;
      }

      function showToast(msg, type, timeout){
        if (type === undefined) type = 'info';
        if (timeout === undefined) timeout = 2400;
        var stack = document.getElementById('toastStack');
        var el = document.createElement('div');
        el.className = 'toast ' + type;
        el.innerHTML = '<span>'+ msg +'</span>';
        stack.appendChild(el);
        requestAnimationFrame(function(){ el.classList.add('show'); });
        function close(){ el.classList.remove('show'); setTimeout(function(){ el.remove(); }, 200); }
        setTimeout(close, timeout);
        return { close: close };
      }

      function productImageCandidates(p){
        var c = [];
        if (p.image) c.push(p.image);
        c.push('images/products/' + p.sku + '.png', 'images/products/' + p.sku + '.webp', 'images/products/' + p.sku + '.jpg');
        return c;
      }
      function attachImgFallback(img, candidates){
        var i = 0;
        function next(){ if (i >= candidates.length){ if (img.parentElement) img.parentElement.style.display='none'; return; } img.src = candidates[i++]; }
        img.onerror = next; next();
      }

      var CATALOG = JSON.parse(document.getElementById('catalogData').textContent);
      var selectedBrand = '';
      var state = { items: [], intl:false, fx:17.00 };

      function currencyCode(){ return state.intl ? 'USD' : 'MXN'; }
      function money(n){ return Number(n||0).toLocaleString(state.intl ? 'en-US' : 'es-MX', { style:'currency', currency: currencyCode() }); }
      function conv(mxn){ return state.intl ? (mxn / Math.max(0.0001, state.fx)) : mxn; }
      function payAmortized(P, annualPct, n){
        var r = (Number(annualPct)||0)/100/12;
        return r<=0 ? P/n : P * (r / (1 - Math.pow(1 + r, -n)));
      }
      function clampQty(v){
        var n = parseInt(v,10); if (isNaN(n)) n = 1;
        if (n < 1) n = 1; if (n > MAX_QTY_PER_PRODUCT) n = MAX_QTY_PER_PRODUCT;
        return n;
      }

      function getDownPct(){
        var downSel = document.getElementById('downPct');
        var sel = downSel ? downSel.value : '0.2';
        if (sel === 'custom') {
          var input = document.getElementById('downPctCustom');
          var v = Number(input && input.value ? input.value : 20);
          if (isNaN(v)) v = 20;
          if (v < 20) { v = 20; if(input) input.value = v; showToast('Enganche mínimo 20%.', 'info'); }
          if (v > 100){ v = 100; if(input) input.value = v; showToast('Enganche máximo 100%.', 'info'); }
          return v / 100;
        }
        return Number(sel || 0.2);
      }

      function refreshCategories(){
        var catSel = document.getElementById('category');
        var current = catSel.value || '';
        catSel.innerHTML = '<option value="">Todas las categorías</option>';
        var seen = {}, categories = [];
        for (var i=0;i<CATALOG.length;i++){
          var c = CATALOG[i].category;
          if (!seen[c]) { seen[c]=1; categories.push(c); }
        }
        categories.sort();
        for (var j=0;j<categories.length;j++){
          var o = document.createElement('option'); o.value=categories[j]; o.textContent=categories[j]; catSel.appendChild(o);
        }
        for (var k=0;k<catSel.options.length;k++){ if (catSel.options[k].value===current){ catSel.value=current; break; } }
      }
      function brandLogoUrlDyn(b){ return BRAND_LOGOS[b] || (b ? ('images/brands/' + slug(b) + '.png') : ''); }
      function refreshBrandChips(){
        var wrap = document.getElementById('brandChips');
        var counts = {};
        for (var i=0;i<CATALOG.length;i++){
          var b = CATALOG[i].brand;
          counts[b] = (counts[b]||0) + 1;
        }
        var brands = [];
        for (var key in counts) if (Object.prototype.hasOwnProperty.call(counts,key)) brands.push(key);
        brands.sort(function(a,b){ return a.localeCompare(b,'es',{sensitivity:'base'}); });

        var html = '';
        for (var j=0;j<brands.length;j++){
          var bname = brands[j];
          html += '<button class="brand-chip '+(selectedBrand===bname?'active':'')+'" data-brand="'+bname+'">'
               +  '<img src="'+brandLogoUrlDyn(bname)+'" alt="'+bname+'" class="brand-logo" onerror="this.style.display=\'none\'">'
               +  '<span>'+(bname || 'Sin marca')+'</span>'
               +  '<span class="count">('+(counts[bname])+')</span>'
               +  '</button>';
        }
        wrap.innerHTML = html;
        var chips = wrap.querySelectorAll('.brand-chip');
        for (var c=0;c<chips.length;c++){
          chips[c].addEventListener('click', function(){
            var b = this.getAttribute('data-brand');
            selectedBrand = (selectedBrand === b) ? '' : b;
            refreshBrandChips(); applyFilters();
          });
        }
        document.getElementById('clearBrand').onclick = function(){ selectedBrand=''; refreshBrandChips(); applyFilters(); };
      }
      function renderCatalog(list) {
        var byBrand = {};
        for (var i=0;i<list.length;i++){
          var p = list[i];
          var k = p.brand || 'Sin marca';
          if (!byBrand[k]) byBrand[k] = [];
          byBrand[k].push(p);
        }
        var brandNames = [];
        for (var key in byBrand) if (Object.prototype.hasOwnProperty.call(byBrand,key)) brandNames.push(key);
        brandNames.sort(function(a,b){ return a.localeCompare(b,'es',{sensitivity:'base'}); });

        var html = '';
        for (var b=0;b<brandNames.length;b++){
          var brand = brandNames[b];
          var itemsList = byBrand[brand];
          var itemsHtml = '';
          for (var j=0;j<itemsList.length;j++){
            var p = itemsList[j];
            itemsHtml += ''
              + '<article class="card bg-white p-4 flex flex-col gap-3">'
              + '  <div class="prod-img"><img class="prod-img-el" alt="'+p.name.replace(/"/g,'&quot;')+'" data-sku="'+p.sku+'"></div>'
              + '  <div class="flex items-center gap-2">'
              + '    <img src="'+brandLogoUrlDyn(p.brand)+'" alt="'+p.brand+'" class="brand-logo" onerror="this.style.display=\'none\'">'
              + '    <h3 class="font-semibold leading-tight">'+p.name+'</h3>'
              + '  </div>'
              + '  <div class="text-xs brand-gray">'+p.category+' • '+(p.brand || 'Sin marca')+'</div>'
              + '  <p class="text-sm">'+(p.description || '')+'</p>'
              + '  <div class="flex items-baseline gap-2 mt-1"><span class="text-lg font-semibold">'+ money(conv(p.unit_price)) +'</span><span class="text-xs brand-gray">('+currencyCode()+')</span></div>'
              + '  <div class="mt-2 flex gap-2">'
              + '    <input type="number" min="1" max="'+MAX_QTY_PER_PRODUCT+'" value="1" class="border rounded px-2 py-1 w-20" id="qty-'+p.sku+'">'
              + '    <button class="px-3 py-2 rounded-2xl btn-brand" data-sku="'+p.sku+'">Agregar</button>'
              + '  </div>'
              + '</article>';
          }
          html += ''
            + '<section class="mb-6">'
            + '  <div class="flex items-center gap-2 mb-2">'
            + '    <img src="'+brandLogoUrlDyn(brand)+'" alt="'+brand+'" class="brand-logo-lg" onerror="this.style.display=\'none\'">'
            + '    <h4 class="text-base uppercase tracking-wide brand-gray">Marca: <span class="text-[var(--brand-dark)] font-semibold">'+brand+'</span></h4>'
            + '  </div>'
            + '  <div class="grid md:grid-cols-2 gap-4">'+itemsHtml+'</div>'
            + '</section>';
        }

        var grid = document.getElementById('catalog');
        grid.innerHTML = html || '<p class="text-sm brand-gray">No hay productos que coincidan.</p>';

        var imgs = grid.querySelectorAll('.prod-img-el');
        for (var ii=0; ii<imgs.length; ii++){
          (function(img){
            var sku = img.getAttribute('data-sku');
            var prod = null;
            for (var z=0; z<list.length; z++){ if (list[z].sku === sku){ prod = list[z]; break; } }
            if (!prod){
              for (var z2=0; z2<CATALOG.length; z2++){ if (CATALOG[z2].sku === sku){ prod = CATALOG[z2]; break; } }
            }
            attachImgFallback(img, productImageCandidates(prod));
            img.addEventListener('click', function(e){ e.preventDefault(); e.stopPropagation(); openModal(img.src, prod ? prod.name : ''); });
          })(imgs[ii]);
        }

        var addBtns = grid.querySelectorAll('button[data-sku]');
        for (var bb=0; bb<addBtns.length; bb++){
          addBtns[bb].addEventListener('click', function(){
            var sku = this.getAttribute('data-sku');
            var p = null;
            for (var t=0;t<CATALOG.length;t++){ if (CATALOG[t].sku===sku){ p = CATALOG[t]; break; } }
            var qtyInput = document.getElementById('qty-'+sku);
            var raw = qtyInput ? qtyInput.value : '1';
            var qty = clampQty(raw);
            if (parseInt(raw,10) > MAX_QTY_PER_PRODUCT) showToast('Máximo '+MAX_QTY_PER_PRODUCT+' unidades por producto.','info');
            addItem(p, qty);
          });
        }
      }
      function applyFilters() {
        var q = (document.getElementById('q').value || '').trim().toLowerCase();
        var cat = document.getElementById('category').value;
        var list = [];
        for (var i=0;i<CATALOG.length;i++){
          var p = CATALOG[i];
          var byQ   = !q || ( (p.sku+' '+p.name+' '+p.description+' '+p.brand).toLowerCase().indexOf(q) !== -1 );
          var byCat = !cat || p.category === cat;
          var byB   = !selectedBrand || (p.brand||'') === selectedBrand;
          if (byQ && byCat && byB) list.push(p);
        }
        renderCatalog(list);
      }

      function addItem(p, qty){
        if (!p) return;
        var add = clampQty(qty);
        var ex = null, idx=-1;
        for (var i=0;i<state.items.length;i++){ if (state.items[i].sku===p.sku){ ex=state.items[i]; idx=i; break; } }
        if (ex) {
          var wanted = ex.qty + add;
          var capped  = clampQty(wanted);
          if (capped === ex.qty) {
            showToast('Máximo '+MAX_QTY_PER_PRODUCT+' unidades por producto.','info');
          } else if (capped < wanted) {
            showToast('Se agregaron '+(capped - ex.qty)+' (tope '+MAX_QTY_PER_PRODUCT+').','info');
          } else {
            showToast('Cantidad actual: '+capped+'.','success',1500);
          }
          ex.qty = capped;
        } else {
          state.items.push({ sku:p.sku, name:p.name, unit_price:p.unit_price, qty:add, category:p.category });
          showToast('Producto agregado ('+add+').','success',1500);
        }
        renderCart();
      }
      function removeItem(i){
        state.items.splice(i,1);
        renderCart();
        showToast('Producto eliminado.','info',1400);
      }
      function updateQty(i, v){
        var prev = state.items[i].qty;
        var newQty = clampQty(v);
        state.items[i].qty = newQty;
        renderCart();
        if (parseInt(v,10) !== newQty) showToast('Máximo '+MAX_QTY_PER_PRODUCT+' unidades por producto.','info');
        else if (newQty !== prev) showToast('Cantidad: '+newQty+'.','success',1200);
      }
      window.removeItem = removeItem; window.updateQty = updateQty;

      function recalc(){
        var subtotalMXN = 0;
        for (var i=0;i<state.items.length;i++){ subtotalMXN += state.items[i].unit_price*state.items[i].qty; }
        var subtotal    = conv(subtotalMXN);
        var discountPct = Math.max(0, Number(document.getElementById('discount').value)||0);
        var discountAmt = subtotal*discountPct/100;
        var base        = subtotal - discountAmt;
        var ivaAmt      = state.intl ? 0 : base*IVA_PCT/100;
        var total       = base + ivaAmt;

        document.getElementById('ivaRow').style.display = state.intl ? 'none' : 'flex';
        document.getElementById('subtotal').textContent   = money(subtotal);
        document.getElementById('discountAmt').textContent= '-' + money(discountAmt);
        document.getElementById('ivaAmt').textContent     = money(ivaAmt);
        document.getElementById('total').textContent      = money(total);

        // Enganche visible en la tarjeta (monto + %)
        var dp = getDownPct();
        document.getElementById('downAmtNow').textContent = money(total * dp);
        document.getElementById('downPctNow').textContent = Math.round(dp*100) + '%';
      }

      function renderCart(){
        var wrap = document.getElementById('cartTable');
        if (!state.items.length){
          wrap.innerHTML = '<p class="text-sm brand-gray">Tu carrito está vacío.</p>';
          recalc(); renderPDF(); return;
        }
        var header = ''
          + '<div class="hdr">'
          + '  <div>Descripción</div>'
          + '  <div class="text-right">Precio</div>'
          + '  <div class="text-right">Cant</div>'
          + '  <div class="text-right"> </div>'
          + '</div>';
        var rows = '';
        for (var i=0;i<state.items.length;i++){
          var it = state.items[i];
          rows += ''
            + '<div class="row">'
            +   '<div class="cart-name col-span-2 sm:col-span-1">'+ it.name +'<div class="text-xs brand-gray sm:hidden mt-0.5">'+ money(conv(it.unit_price)) +'</div></div>'
            +   '<div class="cart-num hidden sm:block">'+ money(conv(it.unit_price)) +'</div>'
            +   '<div class="cart-num">'
            +     '<input type="number" min="1" max="'+MAX_QTY_PER_PRODUCT+'" value="'+it.qty+'" class="border rounded px-2 py-1 cart-qty no-print" onchange="updateQty('+i+', this.value)">'
            +   '</div>'
            +   '<div class="text-right">'
            +     '<button class="trash-btn no-print" title="Eliminar" aria-label="Eliminar" onclick="removeItem('+i+')">'
            +       '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">'
            +         '<path d="M9 3a1 1 0 0 0-1 1v1H5.5a1 1 0 1 0 0 2H6v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V7h.5a1 1 0 1 0 0-2H16V4a1 1 0 0 0-1-1H9zm2 3h2V5h-2v1zm-1 4a1 1 0 0 1 2 0v8a1 1 0 1 1-2 0V10zm5 0a1 1 0 0 1 2 0v8a1 1 0 1 1-2 0V10z"/>'
            +       '</svg>'
            +     '</button>'
            +   '</div>'
            + '</div>';
        }
        wrap.innerHTML = header + rows;
        recalc();
        renderPDF();
      }

      /* Helpers PDF */
      function waitForImages(el){
        var imgs = el.querySelectorAll('img');
        var list = [];
        for (var i=0;i<imgs.length;i++){
          var img = imgs[i];
          if (img.complete) { /* listo */ }
          else {
            list.push(new Promise(function(res){ img.onload = img.onerror = function(){ res(); }; }));
          }
        }
        return Promise.all(list);
      }
      function delay(ms){ return new Promise(function(r){ setTimeout(r, ms); }); }

      function renderPDF(forceShow){
        if (forceShow === undefined) forceShow = false;
        var doc = document.getElementById('pdfDoc');
        doc.style.display = state.items.length ? 'block' : (forceShow ? 'block' : 'none');

        var d = new Date();
        document.getElementById('year').textContent = d.getFullYear();
        document.getElementById('pdfDate').textContent = d.toLocaleDateString('es-MX');
        var v = new Date(d); v.setMonth(v.getMonth() + 1);
        document.getElementById('pdfValidUntil').textContent = v.toLocaleDateString('es-MX');

        document.getElementById('pdfPriceHeader').textContent = 'Precio ('+currencyCode()+')';

        // A nombre de
        var toVal = (document.getElementById('quoteTo').value || '').trim();
        var forRow = document.getElementById('pdfForRow');
        var forSpan= document.getElementById('pdfFor');
        if (toVal){
          forSpan.textContent = toVal;
          forRow.style.display = 'block';
        } else {
          forRow.style.display = 'none';
          forSpan.textContent = '';
        }

        var body = document.getElementById('pdfItemsBody');
        if (!state.items.length){
          body.innerHTML = '<tr><td colspan="4" class="p-4 text-center brand-gray">Sin productos seleccionados.</td></tr>';
          document.getElementById('pdfSubtotal').textContent = money(0);
          document.getElementById('pdfDiscount').textContent = '-' + money(0);
          document.getElementById('pdfIva').textContent      = money(0);
          document.getElementById('pdfTotal').textContent    = money(0);
          document.getElementById('pdfFinTable').innerHTML   = '';
          document.getElementById('pdfDownPct').textContent  = ( (Number(document.getElementById('downPct').value||0.2)*100) + '%' );
          document.getElementById('pdfDownAmt').textContent  = money(0);
          return;
        }

        var rows = '';
        for (var i=0;i<state.items.length;i++){
          var it = state.items[i];
          var catItem = null;
          for (var x=0;x<CATALOG.length;x++){ if (CATALOG[x].sku===it.sku){ catItem = CATALOG[x]; break; } }
          var desc = (catItem && catItem.description) ? catItem.description : '';
          var unit  = conv(it.unit_price);
          var amount= unit*it.qty;
          var imgHtml = INCLUDE_PDF_IMAGES
            ? ('<img src="images/products/'+it.sku+'.png" class="pdf-prod-img" crossorigin="anonymous" onerror="this.style.display=\'none\'">')
            : '';
          rows += ''
            + '<tr class="border-b align-top">'
            +   '<td class="p-2"><div class="flex gap-3">'+ imgHtml +'<div><div class="font-medium">'+ it.name +'</div>'+ (desc ? ('<div class="text-xs text-gray-600 mt-1">'+ desc +'</div>') : '') +'</div></div></td>'
            +   '<td class="p-2 text-right">'+ money(unit) +'</td>'
            +   '<td class="p-2 text-right">'+ it.qty +'</td>'
            +   '<td class="p-2 text-right">'+ money(amount) +'</td>'
            + '</tr>';
        }
        body.innerHTML = rows;

        var subtotalMXN = 0; for (var s=0;s<state.items.length;s++){ subtotalMXN += state.items[s].unit_price*state.items[s].qty; }
        var subtotal    = conv(subtotalMXN);
        var discountPct = Math.max(0, Number(document.getElementById('discount').value)||0);
        var discountAmt = subtotal*discountPct/100;
        var base        = subtotal - discountAmt;
        var ivaAmt      = state.intl ? 0 : base*IVA_PCT/100;
        var total       = base + ivaAmt;

        document.getElementById('pdfIvaRow').style.display = state.intl ? 'none' : 'flex';
        document.getElementById('pdfSubtotal').textContent = money(subtotal);
        document.getElementById('pdfDiscount').textContent = '-' + money(discountAmt);
        document.getElementById('pdfIva').textContent      = money(ivaAmt);
        document.getElementById('pdfTotal').textContent    = money(total);

        var downPct = getDownPct();
        var downAmt = total*downPct;
        var financed = Math.max(0, total - downAmt);
        document.getElementById('pdfDownPct').textContent = Math.round(downPct*100)+'%';
        document.getElementById('pdfDownAmt').textContent = money(downAmt);

        var terms = [12,24,36,48];
        var plansHtml = '';
        for (var t=0;t<terms.length;t++){
          var term = terms[t];
          plansHtml += '<div class="border rounded-xl p-2"><div class="text-xs brand-gray">'+term+' meses</div><div class="font-semibold">'+ money(payAmortized(financed, APR, term)) +'</div></div>';
        }

        // 1/3 + 12 MSI (0% interés)
        var msiDownPct = 1/3;
        var msiDownAmt = total * msiDownPct;
        var msiMonthly = (total - msiDownAmt) / 12;
        var msiHtml = '<div class="border rounded-xl p-2 col-span-2"><div class="text-xs brand-gray">1/3 enganche + 12 MSI (0%)</div><div class="font-semibold">'+ money(msiMonthly) +'</div><div class="text-xs brand-gray mt-1">Enganche: '+ money(msiDownAmt) +'</div></div>';

        document.getElementById('pdfFinTable').innerHTML = plansHtml + msiHtml;
        document.getElementById('finTable').innerHTML    = plansHtml + msiHtml;

        // Instalación/capacitación
        var hasMills  = false, hasOthers = false;
        for (var q=0;q<state.items.length;q++){
          if ((state.items[q].category || '') === 'Fresadoras') hasMills = true; else hasOthers = true;
        }
        var instNote = '';
        if (hasMills && hasOthers) instNote = 'Fresadoras: instalación y capacitación presencial. Otros equipos: instalación y capacitación remota.';
        else if (hasMills) instNote = 'Instalación y capacitación presencial.';
        else instNote = 'Instalación y capacitación remota.';

        var left = state.intl ? ('Moneda: USD. Tipo de cambio: ' + state.fx.toFixed(2) + ' MXN/USD. ' + instNote)
                              : ('Moneda: MXN. ' + instNote);
        document.getElementById('pdfNotesLeft').textContent = left;

        var bottom = state.intl
          ? '<p>Las cotizaciones vencen al mes de generadas. Precios referenciales 2025; sujetos a cambio sin previo aviso. Entrega estimada según equipo. Operación internacional en USD sin IVA. '+ instNote +'</p>'
          : '<p>Las cotizaciones vencen al mes de generadas. Precios referenciales 2025; sujetos a cambio sin previo aviso. Entrega estimada según equipo. '+ instNote +'</p>';
        document.getElementById('pdfNotesBottom').innerHTML = bottom;

        // Datos de contacto
        var contactHtml = '<p class="text-gray-700"><span class="font-semibold">Contacto</span><br>'
                        + 'Tel: +52 1 33 2833 7758'+ CONTACT.phone +' · Correo: cadcam@dental.com.mx '+ CONTACT.email +'<br>'
                        + ' · Dirección: Industria del Plastico #2113, Zapopan, Jal, México'+ CONTACT.address +'</p>';
        document.getElementById('pdfContact').innerHTML = contactHtml;
      }

      // Modal imagen
      var modalEl = document.getElementById('imgModal');
      var modalImg = document.getElementById('modalImg');
      var modalCap = document.getElementById('modalCaption');
      var modalCloseBtn = document.getElementById('modalClose');
      var lastFocused = null;
      function openModal(src, caption){
        if (!src) return;
        lastFocused = document.activeElement;
        modalImg.src = src; modalCap.textContent = caption || '';
        modalEl.classList.remove('hidden'); modalEl.classList.add('flex');
        document.body.style.overflow = 'hidden'; modalCloseBtn.focus();
      }
      function closeModal(){
        modalEl.classList.add('hidden'); modalEl.classList.remove('flex');
        document.body.style.overflow = ''; modalImg.src = '';
        try{ if (lastFocused && lastFocused.focus) lastFocused.focus(); }catch(_){}
      }
      window.openModal = openModal; window.closeModal = closeModal;
      modalEl.addEventListener('click', function(e){ if (e.target === modalEl) closeModal(); });
      modalCloseBtn.addEventListener('click', closeModal);
      window.addEventListener('keydown', function(e){ if (!modalEl.classList.contains('hidden') && e.key === 'Escape') closeModal(); });

      // Filtros
      document.getElementById('apply').addEventListener('click', applyFilters);
      document.getElementById('clear').addEventListener('click', function(){
        document.getElementById('q').value=''; document.getElementById('category').value='';
        selectedBrand=''; refreshBrandChips(); applyFilters();
      });
      document.getElementById('q').addEventListener('keydown', function(e){ if (e.key === 'Enter') applyFilters(); });

      document.getElementById('btnPrint').addEventListener('click', function(){ ensureFolio(); renderPDF(true); window.print(); });

      // Descargar PDF (espera imágenes)
      document.getElementById('btnPDF').addEventListener('click', async function(){
        try{
          var pdfEl = document.getElementById('pdfDoc');
          ensureFolio();
          renderPDF(true);
          pdfEl.style.display = 'block';
          pdfEl.scrollIntoView({behavior:'auto', block:'start'});
          await waitForImages(pdfEl);
          await delay(50);
          var opt = {
            margin: 10,
            filename: 'Cotizacion_' + document.getElementById('pdfFolio').textContent + '.pdf',
            image: { type:'jpeg', quality:0.98 },
            html2canvas: {
              scale: 2, useCORS: true, allowTaint: true, imageTimeout: 1500, scrollY: -window.scrollY
            },
            jsPDF: { unit:'mm', format:'a4', orientation:'portrait' }
          };
          await html2pdf().set(opt).from(pdfEl).save();
        }catch(err){
          console.error(err);
          showToast('No se pudo generar el PDF. Revisa la consola.', 'warn', 2600);
        }
      });

      document.getElementById('btnClearCart').addEventListener('click', function(){ state.items=[]; renderCart(); showToast('Carrito vacío.','info',1200); });
      document.getElementById('discount').addEventListener('input', function(){ recalc(); renderPDF(); });

      // Enganche selector/personalizado
      var downSel = document.getElementById('downPct');
      var downCustomWrap = document.getElementById('downCustomWrap');
      var downCustomInput = document.getElementById('downPctCustom');
      downSel.addEventListener('change', function(){
        var isCustom = downSel.value === 'custom';
        downCustomWrap.classList.toggle('hidden', !isCustom);
        recalc(); renderPDF();
      });
      downCustomInput.addEventListener('input', function(){ recalc(); renderPDF(); });

      // Internacional
      var intlEl = document.getElementById('intl'); var fxEl = document.getElementById('fx'); var fxWrap = document.getElementById('fxWrap');
      intlEl.addEventListener('change', function(){
        state.intl = !!intlEl.checked;
        fxWrap.classList.toggle('hidden', !state.intl);
        renderCart(); // recalcula y repinta precios
        renderCatalog(CATALOG);
        showToast(state.intl ? 'Modo internacional (USD) activado.' : 'Modo MXN activado.','info',1400);
      });
      fxEl.addEventListener('input', function(){
        var v = Number(fxEl.value)||0; state.fx = Math.max(0.0001, v);
        renderCart(); renderCatalog(CATALOG);
      });

      // “A nombre de”: refresca PDF live
      document.getElementById('quoteTo').addEventListener('input', function(){ renderPDF(); });

      // Init
      var d = new Date(); document.getElementById('year').textContent = String(d.getFullYear());
      refreshCategories();
      refreshBrandChips();
      applyFilters();
      renderCart();
      renderPDF();
    });
  </script>
</body>
</html>
